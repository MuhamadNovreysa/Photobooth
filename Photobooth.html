<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photobooth Resa - Fixed Version</title>
  <style>
    /* Reset & Base Styles */
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #app {
      width: 500px;
      max-width: 95vw;
      height: 600px;
      background: #181a29;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 10px 15px;
      position: relative;
    }
    .page {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .page.active { display: flex; }
    button {
      background: #5a67f2;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      color: white;
      cursor: pointer;
      margin: 10px 0;
      transition: transform 0.3s;
    }
    button:hover { transform: scale(1.05); }

    /* Layout Selection */
    .layout-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
    }
    .layout-btn {
      background: #2d2f45;
      border-radius: 8px;
      padding: 10px;
      width: 100px;
      cursor: pointer;
    }
    .layout-btn.selected { background: #5a67f2; }
    .layout-preview {
      width: 80px;
      height: 80px;
      background: #101222;
      border-radius: 6px;
      display: grid;
      gap: 4px;
      padding: 4px;
    }
    .slot { background: #4a4e82; border-radius: 4px; }

    /* Camera Page */
    #video {
      width: 100%;
      max-width: 320px;
      border-radius: 8px;
      margin: 10px 0;
    }
    #capture-status { margin: 10px 0; }

    /* Editing Page */
    #photo-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      height: 400px;
      margin: 10px 0;
    }
    #photo-template-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    .user-photo {
      position: absolute;
      object-fit: cover;
      z-index: 2;
      border: 2px solid white;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    #uploadTemplateBtn {
      background: #ff317b;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Page 1: Welcome -->
    <div id="welcome" class="page active">
      <h1>Photobooth Resa</h1>
      <button id="startButton">Mulai</button>
    </div>

    <!-- Page 2: Layout Selection -->
    <div id="layoutSelection" class="page">
      <h2>Pilih Layout</h2>
      <div class="layout-buttons">
        <button class="layout-btn" data-layout="2x3">
          <div class="layout-preview" style="grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr);">
            <div class="slot"></div><div class="slot"></div><div class="slot"></div>
            <div class="slot"></div><div class="slot"></div><div class="slot"></div>
          </div>
          <span>2x3 Grid</span>
        </button>
      </div>
      <button id="nextButton" disabled>Selanjutnya</button>
    </div>

    <!-- Page 3: Camera -->
    <div id="cameraPage" class="page">
      <h2>Ambil Foto</h2>
      <video id="video" autoplay playsinline></video>
      <div id="capture-status">Foto 1 dari 6</div>
      <button id="captureButton">Ambil Foto</button>
      <button id="nextCameraButton" disabled>Selanjutnya</button>
    </div>

    <!-- Page 4: Editing -->
    <div id="editingPage" class="page">
      <h2>Hasil Photobooth</h2>
      <button id="uploadTemplateBtn">Upload Template</button>
      <input type="file" id="templateUpload" accept="image/*" style="display: none;">
      <div id="photo-container">
        <img id="photo-template-image" src="" alt="Template">
      </div>
      <button id="downloadButton">Download</button>
      <button id="restartButton">Mulai Ulang</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elemen DOM
      const pages = document.querySelectorAll('.page');
      const startButton = document.getElementById('startButton');
      const nextButton = document.getElementById('nextButton');
      const layoutButtons = document.querySelectorAll('.layout-btn');
      const video = document.getElementById('video');
      const captureButton = document.getElementById('captureButton');
      const nextCameraButton = document.getElementById('nextCameraButton');
      const photoContainer = document.getElementById('photo-container');
      const photoTemplateImage = document.getElementById('photo-template-image');
      const downloadButton = document.getElementById('downloadButton');
      const restartButton = document.getElementById('restartButton');
      const captureStatus = document.getElementById('capture-status');
      const uploadTemplateBtn = document.getElementById('uploadTemplateBtn');
      const templateUpload = document.getElementById('templateUpload');

      // State
      let currentPage = 'welcome';
      let selectedLayout = null;
      let photos = [];
      let currentPhotoIndex = 0;
      let videoStream = null;
      let canvas = document.createElement('canvas');
      let ctx = canvas.getContext('2d');

      // Template Default (Contoh: Birthday Party)
      const templates = {
        birthday: {
          // Contoh template kosong (ganti dengan URL/Base64 milikmu)
          image: 'https://drive.google.com/file/d/1f5QDNhyMzwoyF0W9HnZS3PSwwWBuTVJx/view?usp=drivesdk',
          slots: [
            { x: '10%', y: '15%', width: '25%', height: '25%' }, // Slot foto 1
            { x: '40%', y: '15%', width: '25%', height: '25%' },  // Slot foto 2
            { x: '70%', y: '15%', width: '25%', height: '25%' },  // Slot foto 3
            { x: '10%', y: '45%', width: '25%', height: '25%' },  // Slot foto 4
            { x: '40%', y: '45%', width: '25%', height: '25%' },  // Slot foto 5
            { x: '70%', y: '45%', width: '25%', height: '25%' }   // Slot foto 6
          ]
        }
      };

      // Fungsi untuk mengganti halaman
      function showPage(pageId) {
        pages.forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        currentPage = pageId;
      }

      // Event Listeners
      startButton.addEventListener('click', () => showPage('layoutSelection'));
      
      layoutButtons.forEach(button => {
        button.addEventListener('click', () => {
          layoutButtons.forEach(btn => btn.classList.remove('selected'));
          button.classList.add('selected');
          selectedLayout = button.dataset.layout;
          nextButton.disabled = false;
        });
      });

      nextButton.addEventListener('click', () => {
        photos = [];
        currentPhotoIndex = 0;
        showPage('cameraPage');
        startCamera();
        updateCaptureStatus();
      });

      // Upload Template
      uploadTemplateBtn.addEventListener('click', () => {
        templateUpload.click();
      });

      templateUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            templates.birthday.image = event.target.result;
            photoTemplateImage.src = event.target.result;
            alert("Template berhasil diupload!");
          };
          reader.readAsDataURL(file);
        }
      });

      // Ambil Foto
      captureButton.addEventListener('click', () => {
        if (!videoStream) return;
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        photos.push(canvas.toDataURL('image/jpeg'));
        currentPhotoIndex++;
        
        updateCaptureStatus();
        
        if (currentPhotoIndex >= 6) {
          captureButton.disabled = true;
          nextCameraButton.disabled = false;
          captureStatus.textContent = "Semua foto telah diambil!";
        }
      });

      // Lanjut ke Editing
      nextCameraButton.addEventListener('click', () => {
        showPage('editingPage');
        stopCamera();
        displayPhotos();
      });

      // Tampilkan Foto di Template
      function displayPhotos() {
        photoContainer.innerHTML = '';
        
        if (!templates.birthday.image) {
          alert("Upload template dulu!");
          return;
        }
        
        // Load template
        photoTemplateImage.src = templates.birthday.image;
        photoContainer.appendChild(photoTemplateImage);
        
        // Tempatkan foto user
        photos.forEach((photo, index) => {
          if (index < templates.birthday.slots.length) {
            const slot = templates.birthday.slots[index];
            const img = document.createElement('img');
            img.src = photo;
            img.classList.add('user-photo');
            img.style.left = slot.x;
            img.style.top = slot.y;
            img.style.width = slot.width;
            img.style.height = slot.height;
            photoContainer.appendChild(img);
          }
        });
      }

      // Download Hasil
      downloadButton.addEventListener('click', () => {
        if (photos.length === 0 || !templates.birthday.image) {
          alert("Ambil foto dan upload template dulu!");
          return;
        }
        
        const exportCanvas = document.createElement('canvas');
        exportCanvas.width = 800;
        exportCanvas.height = 1200;
        const exportCtx = exportCanvas.getContext('2d');
        
        // Gambar template
        const templateImg = new Image();
        templateImg.onload = () => {
          exportCtx.drawImage(templateImg, 0, 0, exportCanvas.width, exportCanvas.height);
          
          // Gambar semua foto user
          let loadedPhotos = 0;
          photos.forEach((photo, index) => {
            if (index < templates.birthday.slots.length) {
              const slot = templates.birthday.slots[index];
              const img = new Image();
              img.onload = () => {
                const x = parseInt(slot.x) / 100 * exportCanvas.width;
                const y = parseInt(slot.y) / 100 * exportCanvas.height;
                const width = parseInt(slot.width) / 100 * exportCanvas.width;
                const height = parseInt(slot.height) / 100 * exportCanvas.height;
                exportCtx.drawImage(img, x, y, width, height);
                
                loadedPhotos++;
                if (loadedPhotos === Math.min(photos.length, 6)) {
                  // Download
                  const link = document.createElement('a');
                  link.download = 'photobooth-resa.png';
                  link.href = exportCanvas.toDataURL('image/png');
                  link.click();
                }
              };
              img.src = photo;
            }
          });
        };
        templateImg.src = templates.birthday.image;
      });

      // Mulai Kamera
      async function startCamera() {
        try {
          videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = videoStream;
          captureButton.disabled = false;
        } catch (err) {
          alert("Error: " + err.message);
        }
      }

      // Stop Kamera
      function stopCamera() {
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
          videoStream = null;
        }
      }

      // Update Status Ambil Foto
      function updateCaptureStatus() {
        captureStatus.textContent = `Foto ${currentPhotoIndex + 1} dari 6`;
      }

      // Restart
      restartButton.addEventListener('click', () => {
        photos = [];
        currentPhotoIndex = 0;
        stopCamera();
        showPage('welcome');
      });

      // Init
      showPage('welcome');
    });
  </script>
</body>
</html>
