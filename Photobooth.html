<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Photobooth Bisnis Digital</title>
    <style>
        /* CSS Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            color: #333;
            transition: all 0.3s;
        }

        /* Halaman Utama */
        .page {
            display: none;
            min-height: 100vh;
            padding: 20px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .page.active {
            display: flex;
        }

        /* Halaman 1 - Mulai */
        #page-start {
            background: linear-gradient(135deg, #001c8e, #205c8b);
            color: white;
        }

        #page-start h1 {
            font-size: 3rem;
            margin-bottom: 30px;
            text-align: center;
        }

        .start-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: rgb(36, 32, 32);
            color: white;
            border: none;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .start-btn:hover {
            background: #205c8b;
            transform: scale(1.05);
        }

        /* Halaman 2 - Pilih Layout */
        #page-layout {
            background: white;
        }

        .layout-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
            max-width: 800px;
        }

        .layout-option {
            border: 3px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .layout-option:hover {
            border-color: #ff6b6b;
            transform: translateY(-5px);
        }

        /* Halaman 3 - Foto */
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }

        #video {
            width: 100%;
            border-radius: 10px;
            border: 3px solid #ff6b6b;
        }

        #canvas {
            display: none;
            width: 100%;
            border-radius: 10px;
        }

        .countdown {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 10;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #ff5252;
        }

        .control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Halaman 4 - Editing */
        .edit-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
        }

        .edit-section h3 {
            margin-bottom: 15px;
            color: #ff6b6b;
        }

        .frame-colors,
        .stickers {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .frame-color {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .frame-color:hover {
            transform: scale(1.1);
            border-color: #ff6b6b;
        }

        .sticker {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 5px;
        }

        .sticker:hover {
            transform: scale(1.1);
            border-color: #ff6b6b;
        }

        .photo-with-sticker {
            position: relative;
            display: inline-block;
            margin: 10px;
            cursor: pointer;
        }

        .sticker-preview {
            position: absolute;
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 100;
        }

        .final-photo {
            border: 10px solid #ddd;
            border-bottom-width: 40px;
            box-sizing: border-box;
            max-width: 100%;
            height: auto;
            display: block;
        }

        .large-frame {
            border-width: 30px !important;
            border-bottom-width: 80px !important;
        }

        /* Template Text Styles */
        .template-text {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 20;
        }
        
        .large-frame .template-text {
            bottom: 30px;
            font-size: 32px;
        }

        /* Border Icon Styles */
        .border-icon {
            position: absolute;
            pointer-events: none;
            z-index: 15;
            font-size: 20px;
            animation: float 3s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Template Options */
        .template-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .template-option {
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px;
            background: #f5f5f5;
        }

        .template-option i {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .template-option p {
            font-size: 14px;
            font-weight: bold;
            margin: 0;
        }

        .template-option:hover {
            transform: scale(1.05);
            border-color: #ff6b6b;
        }

        .template-option.active {
            border-color: #ff6b6b;
            background-color: #fff0f0;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 100;
            display: none;
            animation: fadeInOut 3s;
        }

        /* Voice Recognition Status */
        .voice-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-status .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff5252;
            animation: pulse 1.5s infinite;
        }

        .voice-status.listening .indicator {
            background-color: #4caf50;
        }

        /* Animations */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        /* Photo Grid */
        #photos-container,
        #final-result {
            display: grid;
            gap: 10px;
            margin: 20px 0;
            justify-items: center;
        }

        .sticker-active {
            border: 3px solid #ff6b6b !important;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        /* Border options */
        .border-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }

        .border-option {
            padding: 10px 15px;
            background: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #ddd;
        }

        .border-option:hover {
            background: #e0e0e0;
        }

        .border-option.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        /* Geometric Patterns */
        .geometric-pattern {
            position: absolute;
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 15;
            opacity: 0.8;
        }

        .geometric-pattern.triangle {
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            background-color: #ff6b6b;
        }

        .geometric-pattern.circle {
            border-radius: 50%;
            background-color: #667eea;
        }

        .geometric-pattern.square {
            background-color: #4caf50;
        }

        .geometric-pattern.hexagon {
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            background-color: #ffc107;
        }

        /* Festival Elements */
        .festival-element {
            position: absolute;
            pointer-events: none;
            z-index: 15;
        }

        .festival-element.confetti {
            width: 60px;
            height: 60px;
            background-image: url('https://cdn-icons-png.flaticon.com/512/2583/2583467.png');
            background-size: contain;
            animation: float 3s infinite ease-in-out;
        }

        .festival-element.sparkle {
            width: 40px;
            height: 40px;
            background-image: url('https://cdn-icons-png.flaticon.com/512/2583/2583345.png');
            background-size: contain;
            animation: spin 2s infinite linear;
        }

        /* Animated Elements */
        .animated-element {
            position: absolute;
            pointer-events: none;
            z-index: 15;
        }

        .animated-element.floating {
            width: 50px;
            height: 50px;
            background-image: url('https://cdn-icons-png.flaticon.com/512/3524/3524636.png');
            background-size: contain;
            animation: float 4s infinite ease-in-out;
        }

        .animated-element.spinning {
            width: 40px;
            height: 40px;
            background-image: url('https://cdn-icons-png.flaticon.com/512/3524/3524659.png');
            background-size: contain;
            animation: spin 3s infinite linear;
        }

        /* Additional Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
        }

        /* Premium Template */
        .premium-template {
            position: relative;
            overflow: hidden;
        }

        .premium-template::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 215, 0, 0.1),
                rgba(255, 215, 0, 0.3),
                transparent,
                rgba(255, 215, 0, 0.1)
            );
            transform: rotate(30deg);
            animation: shine 3s infinite;
        }

        /* Custom Text */
        .custom-text {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 20;
        }

        .large-frame .custom-text {
            bottom: 30px;
            font-size: 32px;
        }

        /* Text Options */
        .text-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .text-options select, 
        .text-options input, 
        .text-options button {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .text-options button {
            background: #ff6b6b;
            color: white;
            border: none;
            cursor: pointer;
        }

        .text-options button:hover {
            background: #ff5252;
        }
    </style>
    <!-- Font Awesome untuk icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://esm.sh/html2canvas@1.4.1"></script>
</head>
<body>
    <!-- Halaman 1 - Mulai -->
    <div id="page-start" class="page active">
        <h1>Photobooth <span> Bisnis Digital </span> </h1>
        <img
            src="hima2.png"
            style="height: 150px; width: 150px; margin-bottom: 15px; margin-right: 10px"
            class="hima"
            alt="Logo Hima"
        />
        <button class="start-btn" id="start-btn">Mulai Photobooth</button>
    </div>

    <!-- Halaman 2 - Pilih Layout -->
    <div id="page-layout" class="page">
        <h2>Pilih Layout Foto</h2>
        <p>Pilih layout untuk sesi fotomu</p>

        <div class="layout-options">
            <div class="layout-option" data-layout="A" data-poses="4">
                <div
                    class="layout-preview"
                    style="background: #eee; height: 150px; display: grid; grid-template-rows: repeat(4, 1fr); gap: 5px"
                >
                    <div style="background: #ff6b6b"></div>
                    <div style="background: #667eea"></div>
                    <div style="background: #4caf50"></div>
                    <div style="background: #ffc107"></div>
                </div>
                <h3>Layout A</h3>
                <p>4 Foto (Vertikal)</p>
            </div>

            <div class="layout-option" data-layout="B" data-poses="3">
                <div
                    class="layout-preview"
                    style="background: #eee; height: 150px; display: grid; grid-template-rows: repeat(3, 1fr); gap: 5px"
                >
                    <div style="background: #ff6b6b"></div>
                    <div style="background: #667eea"></div>
                    <div style="background: #4caf50"></div>
                </div>
                <h3>Layout B</h3>
                <p>3 Foto (Vertikal)</p>
            </div>

            <div class="layout-option" data-layout="C" data-poses="2">
                <div
                    class="layout-preview"
                    style="background: #eee; height: 150px; display: grid; grid-template-rows: repeat(2, 1fr); gap: 5px"
                >
                    <div style="background: #ff6b6b"></div>
                    <div style="background: #667eea"></div>
                </div>
                <h3>Layout C</h3>
                <p>2 Foto (Vertikal)</p>
            </div>

            <div class="layout-option" data-layout="D" data-poses="6">
                <div
                    class="layout-preview"
                    style="background: #eee; height: 150px; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(3, 1fr); gap: 5px"
                >
                    <div style="background: #ff6b6b"></div>
                    <div style="background: #667eea"></div>
                    <div style="background: #4caf50"></div>
                    <div style="background: #ffc107"></div>
                    <div style="background: #9c27b0"></div>
                    <div style="background: #607d8b"></div>
                </div>
                <h3>Layout D</h3>
                <p>6 Foto (2x3)</p>
            </div>

            <div class="layout-option" data-layout="E" data-poses="4">
                <div
                    class="layout-preview"
                    style="background: #eee; height: 150px; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); gap: 5px"
                >
                    <div style="background: #ff6b6b"></div>
                    <div style="background: #667eea"></div>
                    <div style="background: #4caf50"></div>
                    <div style="background: #ffc107"></div>
                </div>
                <h3>Layout E</h3>
                <p>4 Foto (2x2)</p>
            </div>
            <div class="layout-option" data-layout="F" data-poses="1">
                <div
                    class="layout-preview"
                    style="background: #eee; height: 150px; display: grid; grid-template-rows: repeat(1, 1fr); gap: 5px"
                >
                    <div style="background: #ff6b6b"></div>
                </div>
                <h3>Layout F</h3>
                <p>1 Foto (Vertikal)</p>
            </div>
        </div>
    </div>

    <!-- Halaman 3 - Foto -->
    <div id="page-photo" class="page">
        <h2>Ambil Foto</h2>

        <div class="camera-container">
            <div class="countdown" id="countdown" style="display: none">3</div>
            <video id="video" autoplay></video>
            <canvas id="canvas"></canvas>
        </div>

        <div class="controls">
            <select id="filter">
                <option value="none">Tanpa Filter</option>
                <option value="grayscale">Grayscale</option>
                <option value="sepia">Sepia</option>
                <option value="invert">Invert</option>
                <option value="vintage">Vintage</option>
                <option value="cool">Cool</option>
                <option value="warm">Warm</option>
                <option value="blackwhite">Hitam Putih</option>
                <option value="blur">Blur</option>
                <option value="hue-rotate">Pelangi</option>
                <option value="contrast">Kontras Tinggi</option>
                <option value="saturate">Saturasi</option>
                <option value="neon">Neon</option>
                <option value="shadow">Bayangan</option>
                <option value="focus">Soft Focus</option>
            </select>

            <select id="timer">
                <option value="3">Countdown: 3 detik</option>
                <option value="5">Countdown: 5 detik</option>
                <option value="10">Countdown: 10 detik</option>
            </select>

            <button class="control-btn" id="capture-btn">Ambil Foto</button>
            <button class="control-btn" id="delete-btn">Hapus Terakhir</button>
        </div>
        <div id="photo-preview" style="display: none">
            <h3>Pratinjau Foto</h3>
            <div id="photos-container" class="final-photos"></div>
            <button class="control-btn" id="continue-btn">Lanjut ke Editing</button>
        </div>
    </div>

    <!-- Halaman 4 - Editing -->
    <div id="page-edit" class="page">
        <h2>Edit Foto</h2>
        <div class="edit-section">
            <h3>Ukuran Bingkai</h3>
            <div class="border-options">
                <div class="border-option active" data-border-size="small">Kecil</div>
                <div class="border-option" data-border-size="large">Photobooth (Besar)</div>
            </div>
        </div>

        <div class="edit-section">
            <h3>Warna Bingkai</h3>
            <div class="frame-colors">
                <div class="frame-color" style="background-color: #ff6b6b" data-color="#ff6b6b"></div>
                <div class="frame-color" style="background-color: #667eea" data-color="#667eea"></div>
                <div class="frame-color" style="background-color: #4caf50" data-color="#4caf50"></div>
                <div class="frame-color" style="background-color: #ffc107" data-color="#ffc107"></div>
                <div class="frame-color" style="background-color: #9c27b0" data-color="#9c27b0"></div>
                <div class="frame-color" style="background-color: #607d8b" data-color="#607d8b"></div>
                <div class="frame-color" style="background-color: #e91e63" data-color="#e91e63"></div>
                <div class="frame-color" style="background-color: #3f51b5" data-color="#3f51b5"></div>
                <div class="frame-color" style="background-color: #00bcd4" data-color="#00bcd4"></div>
                <div class="frame-color" style="background-color: #8bc34a" data-color="#8bc34a"></div>
                <div class="frame-color" style="background-color: #ffffff" data-color="#ffffff"></div>
                <div class="frame-color" style="background-color: #000000" data-color="#000000"></div>
            </div>
        </div>

        <div class="edit-section">
            <h3>Stiker</h3>
            <div class="stickers">
                <div class="sticker" data-sticker="heart" style="background-image: url('https://cdn-icons-png.flaticon.com/512/535/535183.png')"></div>
                <div class="sticker" data-sticker="star" style="background-image: url('https://cdn-icons-png.flaticon.com/512/1828/1828884.png')"></div>
                <div class="sticker" data-sticker="smile" style="background-image: url('https://cdn-icons-png.flaticon.com/512/742/742751.png')"></div>
                <div class="sticker" data-sticker="crown" style="background-image: url('https://cdn-icons-png.flaticon.com/512/2583/2583344.png')"></div>
                <div class="sticker" data-sticker="music" style="background-image: url('https://cdn-icons-png.flaticon.com/512/3659/3659899.png')"></div>
                <div class="sticker" data-sticker="camera" style="background-image: url('https://cdn-icons-png.flaticon.com/512/891/891398.png')"></div>
                <div class="sticker" data-sticker="flower" style="background-image: url('https://cdn-icons-png.flaticon.com/512/4147/4147711.png')"></div>
                <div class="sticker" data-sticker="balloon" style="background-image: url('https://cdn-icons-png.flaticon.com/512/4276/4276932.png')"></div>
                <div class="sticker" data-sticker="gift" style="background-image: url('https://cdn-icons-png.flaticon.com/512/2583/2583454.png')"></div>
                <div class="sticker" data-sticker="fire" style="background-image: url('https://cdn-icons-png.flaticon.com/512/599/599502.png')"></div>
            </div>
        </div>

        <div class="edit-section">
            <h3>Template Border</h3>
            <div class="template-options">
                <div class="template-option" data-template="geometric">
                    <i class="fas fa-shapes icon-geometric"></i>
                    <p>Geometric</p>
                </div>
                <div class="template-option" data-template="festival">
                    <i class="fas fa-glass-cheers icon-festival"></i>
                    <p>Festival</p>
                </div>
                <div class="template-option" data-template="animated">
                    <i class="fas fa-magic icon-animated"></i>
                    <p>Animated</p>
                </div>
                <div class="template-option" data-template="premium">
                    <i class="fas fa-crown icon-premium"></i>
                    <p>Premium</p>
                </div>
            </div>
        </div>

        <div class="edit-section">
            <h3>Teks Kustom</h3>
            <input type="text" id="custom-text" placeholder="Masukkan teks disini">
            <div class="text-options">
                <select id="text-font">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Comic Sans MS">Comic Sans</option>
                </select>
                <select id="text-color">
                    <option value="#ffffff">Putih</option>
                    <option value="#000000">Hitam</option>
                    <option value="#ff0000">Merah</option>
                    <option value="#00ff00">Hijau</option>
                    <option value="#0000ff">Biru</option>
                    <option value="#ffff00">Kuning</option>
                </select>
                <button id="apply-text">Terapkan Teks</button>
            </div>
        </div>

        <div class="edit-section">
            <h3>Hasil Akhir</h3>
            <div id="final-result" class="final-photos"></div>
            <button class="control-btn" id="download-btn">Download Foto</button>
        </div>

        <div class="notification" id="download-notification">
            Foto berhasil didownload!
        </div>
    </div>

    <!-- Voice Recognition Status -->
    <div class="voice-status" id="voice-status">
        <div class="indicator"></div>
        <span>Voice Command: OFF</span>
    </div>

    <script>
        // DOM Elements
        const startBtn = document.getElementById("start-btn");
        const pages = document.querySelectorAll(".page");
        const layoutOptions = document.querySelectorAll(".layout-option");
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const countdownEl = document.getElementById("countdown");
        const filterSelect = document.getElementById("filter");
        const timerSelect = document.getElementById("timer");
        const captureBtn = document.getElementById("capture-btn");
        const deleteBtn = document.getElementById("delete-btn");
        const continueBtn = document.getElementById("continue-btn");
        const photosContainer = document.getElementById("photos-container");
        const frameColors = document.querySelectorAll(".frame-color");
        const stickers = document.querySelectorAll(".sticker");
        const borderOptions = document.querySelectorAll(".border-option");
        const templateOptions = document.querySelectorAll(".template-option");
        const finalResult = document.getElementById("final-result");
        const downloadBtn = document.getElementById("download-btn");
        const notification = document.getElementById("download-notification");
        const voiceStatus = document.getElementById("voice-status");
        const customTextInput = document.getElementById("custom-text");
        const textFontSelect = document.getElementById("text-font");
        const textColorSelect = document.getElementById("text-color");
        const applyTextBtn = document.getElementById("apply-text");

        // Variabel Global
        let currentPage = "page-start";
        let selectedLayout = null;
        let totalPoses = 0;
        let currentPose = 0;
        let photos = [];
        let countdownInterval = null;
        let currentFilter = "none";
        let selectedFrameColor = "#ff6b6b";
        let activeSticker = null;
        let stickerPositions = {};
        let mediaStream = null;
        let recognition = null;
        let isListening = false;
        let selectedBorderSize = "small";
        let currentTemplate = null;
        let customTextSettings = null;

        // Filter Effects
        const filters = {
            none: "none",
            grayscale: "grayscale(100%)",
            sepia: "sepia(100%)",
            invert: "invert(100%)",
            vintage: "sepia(70%) brightness(80%) contrast(120%)",
            cool: "brightness(90%) contrast(110%) hue-rotate(180deg)",
            warm: "brightness(110%) contrast(110%) hue-rotate(-20deg)",
            blackwhite: "grayscale(100%) contrast(120%)",
            blur: "blur(2px)",
            "hue-rotate": "hue-rotate(90deg)",
            contrast: "contrast(200%)",
            saturate: "saturate(200%)",
            neon: "brightness(120%) contrast(120%) hue-rotate(45deg)",
            shadow: "brightness(90%) contrast(120%) drop-shadow(5px 5px 5px #333)",
            focus: "blur(1px) brightness(110%)",
        };

        // Color names for voice commands
        const colorNames = {
            "#000000": "hitam",
            "#FFFFFF": "putih",
            "#ff6b6b": "merah muda",
            "#667eea": "biru",
            "#4caf50": "hijau",
            "#ffc107": "kuning",
            "#9c27b0": "ungu",
            "#607d8b": "abu-abu",
            "#e91e63": "merah",
            "#3f51b5": "biru tua",
            "#00bcd4": "biru muda",
            "#8bc34a": "hijau muda",
        };

        // Sticker names for voice commands
        const stickerNames = {
            heart: "hati",
            star: "bintang",
            smile: "senyum",
            crown: "mahkota",
            music: "musik",
            camera: "kamera",
            flower: "bunga",
            balloon: "balon",
            gift: "hadiah",
            fire: "api",
        };

        // Template configurations
        const templates = {
            null: {
                apply: function(container) {
                    // Hanya hapus icon dan text yang ada
                    const icons = container.querySelectorAll(".border-icon, .geometric-pattern, .festival-element, .animated-element");
                    icons.forEach(icon => icon.remove());
                    
                    const texts = container.querySelectorAll(".template-text, .custom-text");
                    texts.forEach(text => text.remove());
                    
                    const img = container.querySelector("img");
                    img.style.border = "10px solid " + selectedFrameColor;
                    img.style.borderBottomWidth = "40px";
                    img.style.animation = "none";
                    img.classList.remove("premium-template");
                    
                    if (selectedBorderSize === "large") {
                        img.style.borderWidth = "30px";
                        img.style.borderBottomWidth = "80px";
                    }
                },
                applyToCanvas: function(ctx, canvas, photoIndex) {
                    // Apply basic frame color
                    ctx.fillStyle = selectedFrameColor;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw the photo
                    if (selectedBorderSize === "large") {
                        ctx.drawImage(photos[photoIndex], 30, 30, canvas.width - 60, canvas.height - 110);
                    } else {
                        ctx.drawImage(photos[photoIndex], 10, 10, canvas.width - 20, canvas.height - 50);
                    }
                }
            },
            geometric: {
                apply: function(container) {
                    const img = container.querySelector("img");
                    img.style.borderColor = selectedFrameColor;
                    
                    // Tambahkan elemen geometris
                    addGeometricPattern(container, "10%", "10%", "triangle");
                    addGeometricPattern(container, "90%", "10%", "circle");
                    addGeometricPattern(container, "10%", "90%", "square");
                   
                    addGeometricPattern(container, "90%", "90%", "hexagon");
            
            addTemplateText(container, "Modern Art");
        },
        applyToCanvas: function(ctx, canvas, photoIndex) {
            ctx.fillStyle = selectedFrameColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw photo
            const photoWidth = selectedBorderSize === "large" ? canvas.width - 60 : canvas.width - 20;
            const photoHeight = selectedBorderSize === "large" ? canvas.height - 110 : canvas.height - 50;
            const photoX = selectedBorderSize === "large" ? 30 : 10;
            const photoY = selectedBorderSize === "large" ? 30 : 10;
            
            ctx.drawImage(photos[photoIndex], photoX, photoY, photoWidth, photoHeight);
            
            // Draw geometric shapes
            drawGeometricShape(ctx, canvas.width * 0.1, canvas.height * 0.1, 30, "triangle", "#ff6b6b");
            drawGeometricShape(ctx, canvas.width * 0.9, canvas.height * 0.1, 30, "circle", "#667eea");
            drawGeometricShape(ctx, canvas.width * 0.1, canvas.height * 0.9, 30, "square", "#4caf50");
            drawGeometricShape(ctx, canvas.width * 0.9, canvas.height * 0.9, 30, "hexagon", "#ffc107");
            
            // Add text
            ctx.font = selectedBorderSize === "large" ? "32px Arial" : "24px Arial";
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            ctx.shadowBlur = 4;
            
            const textY = selectedBorderSize === "large" ? canvas.height - 30 : canvas.height - 10;
            ctx.fillText("Modern Art", canvas.width / 2, textY);
        }
    },
    festival: {
        apply: function(container) {
            const img = container.querySelector("img");
            img.style.borderColor = selectedFrameColor;
            
            // Tambahkan elemen festival
            addFestivalElement(container, "20%", "10%", "confetti");
            addFestivalElement(container, "80%", "10%", "sparkle");
            addFestivalElement(container, "50%", "5%", "banner");
            
            addTemplateText(container, "Happy Festival");
        },
        applyToCanvas: function(ctx, canvas, photoIndex) {
            ctx.fillStyle = selectedFrameColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const photoWidth = selectedBorderSize === "large" ? canvas.width - 60 : canvas.width - 20;
            const photoHeight = selectedBorderSize === "large" ? canvas.height - 110 : canvas.height - 50;
            const photoX = selectedBorderSize === "large" ? 30 : 10;
            const photoY = selectedBorderSize === "large" ? 30 : 10;
            
            ctx.drawImage(photos[photoIndex], photoX, photoY, photoWidth, photoHeight);
            
            // Draw festival elements (simplified)
            ctx.fillStyle = "#ffc107";
            drawConfetti(ctx, canvas.width * 0.2, canvas.height * 0.1, 30);
            drawSparkle(ctx, canvas.width * 0.8, canvas.height * 0.1, 20);
            drawBanner(ctx, canvas.width * 0.5, canvas.height * 0.05, 100, 30, "Happy Festival");
            
            // Add text
            ctx.font = selectedBorderSize === "large" ? "32px Arial" : "24px Arial";
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            ctx.shadowBlur = 4;
            
            const textY = selectedBorderSize === "large" ? canvas.height - 30 : canvas.height - 10;
            ctx.fillText("Happy Festival", canvas.width / 2, textY);
        }
    },
    animated: {
        apply: function(container) {
            const img = container.querySelector("img");
            img.style.borderColor = selectedFrameColor;
            img.style.animation = "pulse 2s infinite";
            
            addAnimatedElement(container, "50%", "10%", "floating");
            addAnimatedElement(container, "30%", "80%", "spinning");
            
            addTemplateText(container, "Fun Time");
        },
        applyToCanvas: function(ctx, canvas, photoIndex) {
            ctx.fillStyle = selectedFrameColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const photoWidth = selectedBorderSize === "large" ? canvas.width - 60 : canvas.width - 20;
            const photoHeight = selectedBorderSize === "large" ? canvas.height - 110 : canvas.height - 50;
            const photoX = selectedBorderSize === "large" ? 30 : 10;
            const photoY = selectedBorderSize === "large" ? 30 : 10;
            
            ctx.drawImage(photos[photoIndex], photoX, photoY, photoWidth, photoHeight);
            
            // Draw animated elements (static representation)
            drawFloatingElement(ctx, canvas.width * 0.5, canvas.height * 0.1, 30);
            drawSpinningElement(ctx, canvas.width * 0.3, canvas.height * 0.8, 25);
            
            // Add text
            ctx.font = selectedBorderSize === "large" ? "32px Arial" : "24px Arial";
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            ctx.shadowBlur = 4;
            
            const textY = selectedBorderSize === "large" ? canvas.height - 30 : canvas.height - 10;
            ctx.fillText("Fun Time", canvas.width / 2, textY);
        }
    },
    premium: {
        apply: function(container) {
            const img = container.querySelector("img");
            img.style.borderColor = "#ffd700"; // Gold color for premium
            img.classList.add("premium-template");
            
            addBorderIcon(container, "10%", "10%", "crown");
            addBorderIcon(container, "90%", "10%", "crown");
            addBorderIcon(container, "10%", "90%", "crown");
            addBorderIcon(container, "90%", "90%", "crown");
            
            addTemplateText(container, "Premium Edition");
        },
        applyToCanvas: function(ctx, canvas, photoIndex) {
            // Gold gradient for premium frame
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, "#ffd700");
            gradient.addColorStop(0.5, "#ffec80");
            gradient.addColorStop(1, "#ffd700");
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw photo
            const photoWidth = selectedBorderSize === "large" ? canvas.width - 60 : canvas.width - 20;
            const photoHeight = selectedBorderSize === "large" ? canvas.height - 110 : canvas.height - 50;
            const photoX = selectedBorderSize === "large" ? 30 : 10;
            const photoY = selectedBorderSize === "large" ? 30 : 10;
            
            ctx.drawImage(photos[photoIndex], photoX, photoY, photoWidth, photoHeight);
            
            // Draw crown elements
            ctx.fillStyle = "#ffffff";
            const crownSize = 30;
            
            drawCrown(ctx, canvas.width * 0.1, canvas.height * 0.1, crownSize);
            drawCrown(ctx, canvas.width * 0.9, canvas.height * 0.1, crownSize);
            drawCrown(ctx, canvas.width * 0.1, canvas.height * 0.9, crownSize);
            drawCrown(ctx, canvas.width * 0.9, canvas.height * 0.9, crownSize);
            
            // Add text
            ctx.font = selectedBorderSize === "large" ? "32px Arial" : "24px Arial";
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            ctx.shadowColor = "rgba(0, 0, 0, 0.7)";
            ctx.shadowOffsetX = 3;
            ctx.shadowOffsetY = 3;
            ctx.shadowBlur = 5;
            
            const textY = selectedBorderSize === "large" ? canvas.height - 30 : canvas.height - 10;
            ctx.fillText("Premium Edition", canvas.width / 2, textY);
        }
    }
};

// Fungsi untuk menambahkan pola geometris
function addGeometricPattern(container, left, top, shape) {
    const element = document.createElement("div");
    element.className = `geometric-pattern ${shape}`;
    element.style.left = left;
    element.style.top = top;
    container.appendChild(element);
}

// Fungsi untuk menambahkan elemen festival
function addFestivalElement(container, left, top, type) {
    const element = document.createElement("div");
    element.className = `festival-element ${type}`;
    element.style.left = left;
    element.style.top = top;
    container.appendChild(element);
}

// Fungsi untuk menambahkan elemen animasi
function addAnimatedElement(container, left, top, animation) {
    const element = document.createElement("div");
    element.className = `animated-element ${animation}`;
    element.style.left = left;
    element.style.top = top;
    container.appendChild(element);
}

// Fungsi untuk menggambar bentuk geometris di canvas
function drawGeometricShape(ctx, x, y, size, shape, color) {
    ctx.save();
    ctx.fillStyle = color;
    
    switch(shape) {
        case "triangle":
            ctx.beginPath();
            ctx.moveTo(x, y - size/2);
            ctx.lineTo(x - size/2, y + size/2);
            ctx.lineTo(x + size/2, y + size/2);
            ctx.closePath();
            ctx.fill();
            break;
            
        case "circle":
            ctx.beginPath();
            ctx.arc(x, y, size/2, 0, Math.PI * 2);
            ctx.fill();
            break;
            
        case "square":
            ctx.fillRect(x - size/2, y - size/2, size, size);
            break;
            
        case "hexagon":
            ctx.beginPath();
            ctx.moveTo(x + size * Math.cos(0), y + size * Math.sin(0));
            
            for (let i = 1; i <= 6; i++) {
                ctx.lineTo(x + size * Math.cos(i * 2 * Math.PI / 6), 
                           y + size * Math.sin(i * 2 * Math.PI / 6));
            }
            
            ctx.closePath();
            ctx.fill();
            break;
    }

    ctx.restore();
}

// Fungsi untuk menggambar confetti
function drawConfetti(ctx, x, y, size) {
    ctx.save();
    ctx.fillStyle = "#ff6b6b";
    ctx.beginPath();
    ctx.arc(x, y, size/4, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = "#667eea";
    ctx.beginPath();
    ctx.arc(x + size/2, y - size/3, size/5, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = "#4caf50";
    ctx.beginPath();
    ctx.arc(x - size/3, y + size/4, size/6, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
}

// Fungsi untuk menggambar sparkle
function drawSparkle(ctx, x, y, size) {
    ctx.save();
    ctx.fillStyle = "#ffffff";
    
    // Draw star
    let rot = Math.PI/2*3;
    let spikes = 5;
    let step = Math.PI/spikes;
    let outerRadius = size/2;
    let innerRadius = size/4;

    ctx.beginPath();
    ctx.moveTo(x, y - outerRadius);
    for(let i = 0; i < spikes; i++) {
        let newX = x + Math.cos(rot) * outerRadius;
        let newY = y + Math.sin(rot) * outerRadius;
        ctx.lineTo(newX, newY);
        rot += step;

        newX = x + Math.cos(rot) * innerRadius;
        newY = y + Math.sin(rot) * innerRadius;
        ctx.lineTo(newX, newY);
        rot += step;
    }
    ctx.lineTo(x, y - outerRadius);
    ctx.closePath();
    ctx.fill();
    
    ctx.restore();
}

// Fungsi untuk menggambar banner
function drawBanner(ctx, x, y, width, height, text) {
    ctx.save();
    
    // Draw banner shape
    ctx.fillStyle = "#e91e63";
    ctx.beginPath();
    ctx.moveTo(x - width/2, y);
    ctx.lineTo(x - width/4, y + height);
    ctx.lineTo(x + width/4, y + height);
    ctx.lineTo(x + width/2, y);
    ctx.closePath();
    ctx.fill();
    
    // Draw banner text
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 14px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y + height/2);
    
    ctx.restore();
}

// Fungsi untuk menggambar floating element
function drawFloatingElement(ctx, x, y, size) {
    ctx.save();
    ctx.fillStyle = "#00bcd4";
    
    // Draw cloud shape
    ctx.beginPath();
    ctx.arc(x, y, size/2, 0, Math.PI * 2);
    ctx.arc(x + size/2, y - size/4, size/3, 0, Math.PI * 2);
    ctx.arc(x + size, y, size/4, 0, Math.PI * 2);
    ctx.arc(x + size/2, y + size/4, size/3, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.restore();
}

// Fungsi untuk menggambar spinning element
function drawSpinningElement(ctx, x, y, size) {
    ctx.save();
    ctx.fillStyle = "#9c27b0";
    
    // Draw spiral shape
    ctx.beginPath();
    ctx.moveTo(x, y);
    for (let i = 0; i < 2 * Math.PI; i += 0.1) {
        const radius = size * (1 - i / (2 * Math.PI));
        ctx.lineTo(x + radius * Math.cos(i), y + radius * Math.sin(i));
    }
    ctx.fill();
    
    ctx.restore();
}

// Fungsi untuk menggambar mahkota
function drawCrown(ctx, x, y, size) {
    ctx.save();
    ctx.fillStyle = "#ffc107"; // Gold color
    
    // Draw crown base
    ctx.beginPath();
    ctx.moveTo(x - size, y + size/2);
    ctx.lineTo(x - size, y - size/2);
    ctx.lineTo(x - size/2, y);
    ctx.lineTo(x, y - size/2);
    ctx.lineTo(x + size/2, y);
    ctx.lineTo(x + size, y - size/2);
    ctx.lineTo(x + size, y + size/2);
    ctx.closePath();
    ctx.fill();
    
    // Draw jewels
    ctx.fillStyle = "#ff6b6b";
    ctx.beginPath();
    ctx.arc(x - size/2, y - size/4, size/4, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = "#667eea";
    ctx.beginPath();
    ctx.arc(x, y - size/2, size/4, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = "#4caf50";
    ctx.beginPath();
    ctx.arc(x + size/2, y - size/4, size/4, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.restore();
}

// Fungsi untuk menambahkan icon di border dengan posisi persentase
function addBorderIcon(container, left, top, iconType) {
    const icon = document.createElement("i");
    icon.className = `border-icon fas fa-${iconType} icon-${iconType}`;
    icon.style.left = left;
    icon.style.top = top;
    container.appendChild(icon);
}

// Fungsi untuk menambahkan text decoration
function addTemplateText(container, text) {
    const textEl = document.createElement("div");
    textEl.className = "template-text";
    textEl.textContent = text;
    container.appendChild(textEl);
}

// Initialize voice recognition
function initVoiceRecognition() {
    try {
        const SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = "id-ID";

        recognition.onstart = function () {
            isListening = true;
            voiceStatus.classList.add("listening");
            voiceStatus.querySelector("span").textContent = "Voice Command: ON";
        };

        recognition.onend = function () {
            isListening = false;
            voiceStatus.classList.remove("listening");
            voiceStatus.querySelector("span").textContent = "Voice Command: OFF";
            if (currentPage !== "page-start") {
                setTimeout(startListening, 500);
            }
        };

        recognition.onerror = function (event) {
            console.error("Voice recognition error", event.error);
            if (event.error === "not-allowed") {
                voiceStatus.querySelector("span").textContent =
                    "Voice Command: Blocked";
            }
        };

        recognition.onresult = function (event) {
            const last = event.results.length - 1;
            const command = event.results[last][0].transcript.toLowerCase().trim();
            console.log("Voice command:", command);

            handleVoiceCommand(command);
        };

        startListening();
    } catch (e) {
        console.error("Voice recognition not supported", e);
        voiceStatus.style.display = "none";
    }
}

// Start listening for voice commands
function startListening() {
    if (recognition && !isListening) {
        try {
            recognition.start();
        } catch (e) {
            console.error("Error starting recognition:", e);
        }
    }
}

// Stop listening for voice commands
function stopListening() {
    if (recognition && isListening) {
        recognition.stop();
    }
}

function handleVoiceCommand(command) {
    switch (currentPage) {
        case "page-start":
            if (command.includes("mulai")) {
                startBtn.click();
            }
            break;

        case "page-layout":
            if (command.includes("empat foto vertikal")) {
                document.querySelector('.layout-option[data-layout="A"]').click();
            } else if (command.includes("tiga foto vertikal")) {
                document.querySelector('.layout-option[data-layout="B"]').click();
            } else if (command.includes("dua foto vertikal")) {
                document.querySelector('.layout-option[data-layout="C"]').click();
            } else if (command.includes("enam foto dua kali tiga")) {
                document.querySelector('.layout-option[data-layout="D"]').click();
            } else if (command.includes("empat foto 2 kali 2")) {
                document.querySelector('.layout-option[data-layout="E"]').click();                                   
            } else if (command.includes("satu foto vertikal")) {
                document.querySelector('.layout-option[data-layout="F"]').click();
            }
            break;

        case "page-photo":
            // Perubahan untuk filter - dipisah menjadi 2 tahap
            if (command === "filter") {
                filterSelect.focus();
                if ("speechSynthesis" in window) {
                    const speech = new SpeechSynthesisUtterance();
                    speech.text = "Silakan sebutkan nama filter yang diinginkan";
                    speech.lang = "id-ID";
                    window.speechSynthesis.speak(speech);
                }
            } 
            else if (filterSelect === document.activeElement) {
                // Jika dropdown filter sedang aktif/focus
                if (command.includes("grayscale") || command.includes("abu-abu")) {
                    filterSelect.value = "grayscale";
                } else if (command.includes("sepia")) {
                    filterSelect.value = "sepia";
                } else if (command.includes("invert")) {
                    filterSelect.value = "invert";
                } else if (command.includes("vintage")) {
                    filterSelect.value = "vintage";
                } else if (command.includes("cool")) {
                    filterSelect.value = "cool";
                } else if (command.includes("warm")) {
                    filterSelect.value = "warm";
                } else if (command.includes("hitam putih") || command.includes("blackwhite")) {
                    filterSelect.value = "blackwhite";
                } else if (command.includes("blur")) {
                    filterSelect.value = "blur";
                } else if (command.includes("pelangi") || command.includes("hue rotate")) {
                    filterSelect.value = "hue-rotate";
                } else if (command.includes("kontras") || command.includes("contrast")) {
                    filterSelect.value = "contrast";
                } else if (command.includes("saturasi") || command.includes("saturate")) {
                    filterSelect.value = "saturate";
                } else if (command.includes("neon")) {
                    filterSelect.value = "neon";
                } else if (command.includes("bayangan") || command.includes("shadow")) {
                    filterSelect.value = "shadow";
                } else if (command.includes("focus") || command.includes("soft focus")) {
                    filterSelect.value = "focus";
                } else if (command.includes("none") || command.includes("tanpa filter")) {
                    filterSelect.value = "none";
                }
                filterSelect.dispatchEvent(new Event("change"));
            }
            // Perubahan untuk hitung mundur - dipisah menjadi 2 tahap
            else if (command === "hitung mundur") {
                timerSelect.focus();
                if ("speechSynthesis" in window) {
                    const speech = new SpeechSynthesisUtterance();
                    speech.text = "Silakan sebutkan durasi hitung mundur: 3, 5, atau 10 detik";
                    speech.lang = "id-ID";
                    window.speechSynthesis.speak(speech);
                }
            }
            else if (timerSelect === document.activeElement) {
                // Jika dropdown timer sedang aktif/focus
                if (command.includes("3") || command.includes("3 detik") || command.includes("3s")) {
                    timerSelect.value = "3";
                } else if (command.includes("5") || command.includes("5 detik") || command.includes("5s")) {
                    timerSelect.value = "5";
                } else if (command.includes("10") || command.includes("10 detik") || command.includes("10s")) {
                    timerSelect.value = "10";
                }
                timerSelect.dispatchEvent(new Event("change"));
            }
            else if (command.includes("cekrek") || command.includes("ambil foto") || command.includes("capture")) {
                captureBtn.click();
            } else if (command.includes("hapus") || command.includes("delete")) {
                deleteBtn.click();
            } else if (command.includes("lanjut") || command.includes("continue")) {
                if (continueBtn.style.display !== "none") {
                    continueBtn.click();
                }
            }
            break;

        case "page-edit":
            if (command.includes("warna")) {
                for (const [colorCode, colorName] of Object.entries(colorNames)) {
                    if (command.includes(colorName)) {
                        const colorElement = document.querySelector(
                            `.frame-color[data-color="${colorCode}"]`
                        );
                        if (colorElement) {
                            colorElement.click();
                        }
                        break;
                    }
                }
            } 
            else if (command.includes("stiker") || command.includes("sticker") || command.includes("emoji")) {
                for (const [stickerId, stickerName] of Object.entries(stickerNames)) {
                    if (command.includes(stickerName)) {
                        const stickerElement = document.querySelector(
                            `.sticker[data-sticker="${stickerId}"]`
                        );
                        if (stickerElement) {
                            stickerElement.click();
                        }
                        break;
                    }
                }
            }
            // Perubahan untuk ukuran bingkai
            else if (command.includes("ukuran bingkai") || command.includes("border size")) {
                if (command.includes("kecil") || command.includes("small")) {
                    document.querySelector('.border-option[data-border-size="small"]').click();
                } else if (command.includes("besar") || command.includes("large") || command.includes("photobooth")) {
                    document.querySelector('.border-option[data-border-size="large"]').click();
                }
            }
            // Perubahan untuk template border
            else if (command.includes("template") || command.includes("bingkai")) {
                if (command.includes("geometric") || command.includes("geometris")) {
                    document.querySelector('.template-option[data-template="geometric"]').click();
                } else if (command.includes("festival") || command.includes("pesta")) {
                    document.querySelector('.template-option[data-template="festival"]').click();
                } else if (command.includes("animated") || command.includes("animasi")) {
                    document.querySelector('.template-option[data-template="animated"]').click();
                } else if (command.includes("premium")) {
                    document.querySelector('.template-option[data-template="premium"]').click();
                }
            }
            // Perubahan untuk custom text
            else if (command.includes("teks") || command.includes("text") || command.includes("tulisan")) {
                if (command.includes("tambah") || command.includes("add")) {
                    const textMatch = command.match(/tulis(kan)?\s+(.+)/);
                    if (textMatch && textMatch[2]) {
                        customTextInput.value = textMatch[2];
                        applyTextBtn.click();
                    }
                }
            }
            else if (command.includes("download") || command.includes("unduh")) {
                downloadBtn.click();
            }
            break;
    }
}

// Fungsi Navigasi Halaman
function showPage(pageId) {
    if (currentPage === "page-photo" && pageId !== "page-photo") {
        stopCamera();
    }

    pages.forEach((page) => {
        page.classList.remove("active");
    });
    document.getElementById(pageId).classList.add("active");
    currentPage = pageId;

    if (pageId === "page-photo") {
        initCamera();
        if (!isListening) {
            startListening();
        }
    } else if (pageId === "page-start") {
        stopListening();
    } else {
        startListening();
    }
}

// Inisialisasi Kamera (Versi Baru - Non Mirror)
async function initCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: "user",
            },
        });

        mediaStream = stream;
        video.srcObject = stream;
        
        // Nonaktifkan mirror effect di preview kamera
        video.style.transform = "scaleX(1)"; // Tidak dibalik (normal)
        await video.play();
    } catch (err) {
        console.error("Error kamera:", err);
        alert("Tidak bisa mengakses kamera. Mohon izinkan akses kamera.");
    }
}

// Hentikan Kamera (Tetap Sama)
function stopCamera() {
    if (mediaStream) {
        mediaStream.getTracks().forEach((track) => track.stop());
        video.srcObject = null;
    }
}

// Mulai Countdown
function startCountdown() {
    if (photos.length >= totalPoses) {
        // Prevent capturing more photos than totalPoses
        return;
    }
    let timeLeft = parseInt(timerSelect.value);
    countdownEl.textContent = timeLeft;
    countdownEl.style.display = "flex";

    captureBtn.disabled = true;
    deleteBtn.disabled = true;

    countdownInterval = setInterval(() => {
        timeLeft--;
        countdownEl.textContent = timeLeft;

        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            countdownEl.style.display = "none";
            takePhoto();

            if (photos.length < totalPoses) {
                setTimeout(() => {
                    startCountdown();
                }, 1000);
            } else {
                captureBtn.disabled = false;
                deleteBtn.disabled = photos.length === 0;
                document.getElementById("photo-preview").style.display = "block";
            }
        }
    }, 1000);
}

// Ambil Foto
function takePhoto() {
    const targetWidth = 600;
    const targetHeight = 900;

    canvas.width = targetWidth;
    canvas.height = targetHeight;

    // Pastikan gambar tidak dibalik (non-mirror)
    ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transformasi
    ctx.filter = filters[currentFilter];

    // Hitung posisi gambar (tanpa mirror)
    const videoAspect = video.videoWidth / video.videoHeight;
    const canvasAspect = targetWidth / targetHeight;

    let renderWidth, renderHeight, offsetX, offsetY;

    if (videoAspect > canvasAspect) {
        renderHeight = targetHeight;
        renderWidth = video.videoWidth * (targetHeight / video.videoHeight);
        offsetX = (targetWidth - renderWidth) / 2;
        offsetY = 0;
    } else {
        renderWidth = targetWidth;
        renderHeight = video.videoHeight * (targetWidth / video.videoWidth);
        offsetX = 0;
        offsetY = (targetHeight - renderHeight) / 2;
    }

    // Gambar langsung ke canvas tanpa mirror
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(video, offsetX, offsetY, renderWidth, renderHeight);

    const photoData = canvas.toDataURL("image/png");
    photos.push(photoData);
    currentPose = photos.length;

    updatePhotoPreview();
}

// Update Preview Foto
function updatePhotoPreview() {
    photosContainer.innerHTML = "";
    photos.forEach((photo, index) => {
        const container = document.createElement("div");
        container.className = "photo-with-sticker";
        container.dataset.photoIndex = index;

        const img = document.createElement("img");
        img.src = photo;
        img.className = "final-photo";
        if (selectedBorderSize === "large") {
            img.classList.add("large-frame");
        }
        img.style.borderColor = selectedFrameColor;

        container.appendChild(img);
        photosContainer.appendChild(container);
    });
}

// Render Foto untuk Editing
function renderFinalPhotos() {
    finalResult.innerHTML = "";

    if (photos.length === 0) {
        finalResult.innerHTML =
            "<p>Tidak ada foto untuk ditampilkan. Silakan ambil foto terlebih dahulu.</p>";
        return;
    }

    photos.forEach((photo, photoIndex) => {
        const container = document.createElement("div");
        container.className = "photo-with-sticker";
        container.dataset.photoIndex = photoIndex;

        const img = document.createElement("img");
        img.src = photo;
        img.className = "final-photo";
        img.style.display = "block";
        img.style.maxWidth = "100%";
        img.style.height = "auto";

        if (selectedBorderSize === "large") {
            img.classList.add("large-frame");
        }

        container.appendChild(img);

        // Apply template - ensure correct application on container
        if (currentTemplate && templates[currentTemplate]) {
            templates[currentTemplate].apply(container);
        } else {
            templates["null"].apply(container);
        }

        // Add custom text if any
        if (customTextSettings) {
            const textEl = document.createElement("div");
            textEl.className = "custom-text";
            textEl.textContent = customTextSettings.text;
            textEl.style.fontFamily = customTextSettings.font;
            textEl.style.color = customTextSettings.color;
            textEl.style.position = "absolute";
            textEl.style.bottom = "20px";
            textEl.style.left = "0";
            textEl.style.right = "0";
            textEl.style.textAlign = "center";
            textEl.style.fontSize = "24px";
            textEl.style.textShadow = "2px 2px 4px rgba(0,0,0,0.5)";
            
            if (selectedBorderSize === "large") {
                textEl.style.bottom = "30px";
                textEl.style.fontSize = "32px";
            }
            
            container.appendChild(textEl);
        }

        // Add stickers if any
        if (stickerPositions[photoIndex]) {
            stickerPositions[photoIndex].forEach((sticker, idx) => {
                const stickerEl = document.createElement("div");
                stickerEl.className = "sticker-preview";
                stickerEl.style.backgroundImage = sticker.backgroundImage;
                stickerEl.style.left = `${sticker.x}px`;
                stickerEl.style.top = `${sticker.y}px`;
                stickerEl.dataset.stickerIndex = idx;
                container.appendChild(stickerEl);
            });
        }

        finalResult.appendChild(container);
    });

    // Add click listeners for stickers (to add more)
    document.querySelectorAll(".photo-with-sticker").forEach((container) => {
        container.addEventListener("click", (e) => {
            if (
                activeSticker &&
                (e.target === container || e.target === container.querySelector("img"))
            ) {
                const img = container.querySelector("img");
                const rect = img.getBoundingClientRect();

                const x = e.clientX - rect.left - 40;
                const y = e.clientY - rect.top - 40;

                const boundedX = Math.max(0, Math.min(x, rect.width - 80));
                const boundedY = Math.max(0, Math.min(y, rect.height - 80));

                const photoIndex = parseInt(container.dataset.photoIndex);
                if (!stickerPositions[photoIndex]) {
                    stickerPositions[photoIndex] = [];
                }

                stickerPositions[photoIndex].push({
                    backgroundImage: activeSticker.style.backgroundImage,
                    x: boundedX,
                    y: boundedY,
                });

                renderFinalPhotos();
            }
        });
    });
}

// Fungsi untuk memuat gambar (dipakai saat download)
function loadImage(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = src;
        img.onload = () => resolve(img);
        img.onerror = (err) => reject(err);
    });
}

// Event Listeners
if (startBtn) {
    startBtn.addEventListener("click", () => showPage("page-layout"));
}

layoutOptions.forEach((option) => {
    option.addEventListener("click", () => {
        selectedLayout = option.dataset.layout;
        totalPoses = parseInt(option.dataset.poses);
        currentPose = 0;
        photos = [];
        stickerPositions = {};
        showPage("page-phpage-ph");
            });
        });

        if (filterSelect) {
            filterSelect.addEventListener("change", () => {
                currentFilter = filterSelect.value;
                video.style.filter = filters[currentFilter];
            });
        }

        if (captureBtn) {
            captureBtn.addEventListener("click", startCountdown);
        }

        if (deleteBtn) {
            deleteBtn.addEventListener("click", () => {
                if (photos.length > 0) {
                    photos.pop();
                    delete stickerPositions[photos.length];
                    updatePhotoPreview();
                    currentPose = photos.length;

                    if (photos.length === 0) {
                        document.getElementById("photo-preview").style.display = "none";
                    }
                }
            });
        }

        if (continueBtn) {
            continueBtn.addEventListener("click", () => {
                showPage("page-edit");
                renderFinalPhotos();
            });
        }

        frameColors.forEach((color) => {
            color.addEventListener("click", () => {
                selectedFrameColor = color.dataset.color;
                renderFinalPhotos();
            });
        });

        borderOptions.forEach((option) => {
            option.addEventListener("click", function () {
                borderOptions.forEach((opt) => {
                    opt.classList.remove("active");
                });

                this.classList.add("active");
                selectedBorderSize = this.dataset.borderSize;
                renderFinalPhotos();
            });
        });

        stickers.forEach((sticker) => {
            sticker.addEventListener("click", (e) => {
                stickers.forEach((s) => s.classList.remove("sticker-active"));
                e.target.classList.add("sticker-active");
                activeSticker = e.target;
            });
        });

        templateOptions.forEach((option) => {
            option.addEventListener("click", function () {
                templateOptions.forEach((opt) => {
                    opt.classList.remove("active");
                });

                this.classList.add("active");
                currentTemplate = this.dataset.template;
                renderFinalPhotos();
            });
        });

        // Apply custom text
        applyTextBtn.addEventListener("click", function() {
            const text = customTextInput.value.trim();
            if (text) {
                customTextSettings = {
                    text: text,
                    font: textFontSelect.value,
                    color: textColorSelect.value
                };
                renderFinalPhotos();
            }
        });

        // Download button handler
        downloadBtn.addEventListener("click", async function() {
            if (photos.length === 0) {
                alert("Belum ada foto yang diambil!");
                return;
            }

            const originalText = downloadBtn.textContent;
            downloadBtn.disabled = true;
            downloadBtn.textContent = "Memproses...";

            try {
                // Create a container for all photos
                const container = document.createElement("div");
                container.style.display = "none";
                document.body.appendChild(container);

                // Create canvas for each photo with template applied
                const canvases = await Promise.all(photos.map(async (photo, index) => {
                    const photoContainer = document.createElement("div");
                    photoContainer.className = "photo-with-sticker";
                    
                    const img = document.createElement("img");
                    img.src = photo;
                    img.className = "final-photo";
                    if (selectedBorderSize === "large") {
                        img.classList.add("large-frame");
                    }
                    img.style.borderColor = selectedFrameColor;
                    
                    photoContainer.appendChild(img);
                    container.appendChild(photoContainer);

                    // Apply template
                    if (currentTemplate && templates[currentTemplate]) {
                        templates[currentTemplate].apply(photoContainer);
                    }

                    // Add custom text if any
                    if (customTextSettings) {
                        const textEl = document.createElement("div");
                        textEl.className = "custom-text";
                        textEl.textContent = customTextSettings.text;
                        textEl.style.fontFamily = customTextSettings.font;
                        textEl.style.color = customTextSettings.color;
                        textEl.style.position = "absolute";
                        textEl.style.bottom = selectedBorderSize === "large" ? "30px" : "20px";
                        textEl.style.left = "0";
                        textEl.style.right = "0";
                        textEl.style.textAlign = "center";
                        textEl.style.fontSize = selectedBorderSize === "large" ? "32px" : "24px";
                        textEl.style.textShadow = "2px 2px 4px rgba(0,0,0,0.5)";
                        
                        photoContainer.appendChild(textEl);
                    }

                    // Add stickers if any
                    if (stickerPositions[index]) {
                        stickerPositions[index].forEach((sticker) => {
                            const stickerEl = document.createElement("div");
                            stickerEl.className = "sticker-preview";
                            stickerEl.style.backgroundImage = sticker.backgroundImage;
                            stickerEl.style.left = `${sticker.x}px`;
                            stickerEl.style.top = `${sticker.y}px`;
                            photoContainer.appendChild(stickerEl);
                        });
                    }

                    // Wait for elements to render
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // Convert to canvas
                    const { default: html2canvas } = await import("https://esm.sh/html2canvas@1.4.1");
                    const canvas = await html2canvas(photoContainer, {
                        scale: 1,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: null
                    });

                    return canvas;
                });

                // Combine canvases based on layout
                let finalCanvas;
                if (selectedLayout === "D") { // 2x3 layout
                    finalCanvas = document.createElement("canvas");
                    finalCanvas.width = 1200;
                    finalCanvas.height = 1800;
                    const ctx = finalCanvas.getContext("2d");
                    
                    // Draw each photo in grid
                    for (let i = 0; i < 6; i++) {
                        if (canvases[i]) {
                            const row = Math.floor(i / 3);
                            const col = i % 3;
                            const x = col * 600;
                            const y = row * 600;
                            ctx.drawImage(canvases[i], x, y, 600, 600);
                        }
                    }
                } else if (selectedLayout === "E") { // 2x2 layout
                    finalCanvas = document.createElement("canvas");
                    finalCanvas.width = 1200;
                    finalCanvas.height = 1200;
                    const ctx = finalCanvas.getContext("2d");
                    
                    for (let i = 0; i < 4; i++) {
                        if (canvases[i]) {
                            const row = Math.floor(i / 2);
                            const col = i % 2;
                            const x = col * 600;
                            const y = row * 600;
                            ctx.drawImage(canvases[i], x, y, 600, 600);
                        }
                    }
                } else { // Single column layouts
                    finalCanvas = document.createElement("canvas");
                    const isLarge = selectedBorderSize === "large";
                    const width = isLarge ? 1200 : 800;
                    const height = isLarge ? 1800 : 1200;
                    
                    finalCanvas.width = width;
                    finalCanvas.height = height * photos.length;
                    const ctx = finalCanvas.getContext("2d");
                    
                    photos.forEach((_, index) => {
                        if (canvases[index]) {
                            ctx.drawImage(canvases[index], 0, height * index, width, height);
                        }
                    });
                }

                // Clean up
                document.body.removeChild(container);

                // Download
                finalCanvas.toBlob(blob => {
                    const link = document.createElement("a");
                    link.download = `photobooth-${new Date().getTime()}.png`;
                    link.href = URL.createObjectURL(blob);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    notification.style.display = "block";
                    setTimeout(() => notification.style.display = "none", 3000);
                }, "image/png", 1);

            } catch (error) {
                console.error("Download Error:", error);
                alert("Error saat memproses foto. Coba lagi.");
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.textContent = originalText;
            }
        });

        // Initialize voice recognition when the page loads
        window.addEventListener("DOMContentLoaded", () => {
            initVoiceRecognition();

            setTimeout(() => {
                if ("speechSynthesis" in window) {
                    const speech = new SpeechSynthesisUtterance();
                    speech.text =
                        "Selamat datang di Photobooth Bisnis Digital. Anda dapat menggunakan perintah suara. Katakan 'Mulai' untuk memulai.";
                    speech.lang = "id-ID";
                    window.speechSynthesis.speak(speech);
                }
            }, 1000);
        });

        // Cleanup
        window.addEventListener("beforeunload", () => {
            stopCamera();
            stopListening();
        });
    </script>
</body>
</html>


